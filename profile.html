<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì S∆° C·ªßa T√¥i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Awesome ƒë·ªÉ d√πng icon b√∫t ch√¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="icon" type="image/png" href="image/icon.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #333;
        }

        /* Th√™m style cho ph·∫ßn feedback */
        .feedback {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            display: none;
            text-align: left;
        }

        .feedback.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .feedback.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* CSS cho input b·ªã kh√≥a */
        .input-locked {
            background-color: #f3f4f6;
            cursor: not-allowed;
            border-color: #d1d5db;
        }

        /* CSS cho input ƒë√£ m·ªü kh√≥a */
        .input-editable {
            background-color: #ffffff;
            cursor: text;
            border-color: #ef4444;
            /* Vi·ªÅn ƒë·ªè khi ƒëang ch·ªânh s·ª≠a */
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- Header section -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-12">
                    <a href="#" class="flex items-center space-x-2">
                        <!-- Placeholder logo -->
                        <img src="image/logo.png" alt="AnhEm Motor Logo" class="rounded-full w-10 h-10"
                            onerror="this.onerror=null; this.src='https://placehold.co/40x40/34495e/ffffff?text=L';">
                        <span class="text-xl font-bold text-gray-900">AnhEm Motor</span>
                    </a>
                    <nav class="hidden md:flex space-x-8">
                        <a href="index.html" class="text-base font-medium text-gray-500 hover:text-gray-900">Trang
                            Ch·ªß</a>
                        <a href="listing.html" class="text-base font-medium text-gray-500 hover:text-gray-900">S·∫£n
                            Ph·∫©m</a>
                        <a href="about.html" class="text-base font-medium text-gray-500 hover:text-gray-900">Gi·ªõi
                            Thi·ªáu</a>
                        <a href="news.html" class="text-base font-medium text-gray-500 hover:text-gray-900">Tin T·ª©c-S·ª±
                            Ki·ªán</a>
                        <a href="promotion.html" class="text-base font-medium text-gray-500 hover:text-gray-900">Khuy·∫øn
                            M√£i</a>
                        <a href="contact.html" class="text-base font-medium text-gray-500 hover:text-gray-900">Li√™n
                            H·ªá</a>
                        <a href="service.html" class="text-base font-medium text-gray-500 hover:text-gray-900">D·ªãch
                            V·ª•</a>
                        <!-- Th√™m n√∫t ƒêƒÉng xu·∫•t -->
                        <button id="logout-btn" class="text-base font-medium text-red-600 hover:text-red-800">ƒêƒÉng
                            Xu·∫•t</button>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 md:p-12 mt-8">
        <h1 class="text-3xl font-bold mb-2 text-gray-800">H·ªì S∆° C·ªßa T√¥i</h1>
        <p class="text-sm text-gray-500 mb-8">Qu·∫£n l√Ω th√¥ng tin h·ªì s∆° ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>

        <!-- Khu v·ª±c th√¥ng b√°o (Feedback) -->
        <div id="global-feedback" class="feedback"></div>
        <div id="loading" class="text-center py-4 hidden">
            <div class="spinner border-4 border-gray-200 border-t-red-500 rounded-full w-8 h-8 mx-auto animate-spin">
            </div>
            <p class="text-sm text-gray-600 mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <!-- Avatar section -->
        <div class="flex flex-col items-center mb-8">
            <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-gray-200 shadow-lg mb-4">
                <!-- Avatar Preview -->
                <img id="avatar-preview" src="https://placehold.co/128x128/bdbdbd/ffffff?text=Avatar"
                    alt="Avatar ng∆∞·ªùi d√πng" class="w-full h-full object-cover">
            </div>
            <label
                class="inline-flex justify-center rounded-full border border-gray-300 shadow-sm px-6 py-2 bg-gray-100 text-base font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm cursor-pointer">
                Ch·ªçn ·∫¢nh
                <input type="file" id="avatar-upload" class="hidden" accept="image/jpeg, image/png">
            </label>
            <p class="mt-2 text-xs text-gray-500 text-center">
                Dung l∆∞·ª£ng file t·ªëi ƒëa 1 MB<br>
                ƒê·ªãnh d·∫°ng: JPEG, PNG
            </p>
        </div>

        <!-- Form fields below the avatar -->
        <form id="profile-form">
            <div class="space-y-6">
                <!-- T√™n ƒëƒÉng nh·∫≠p (ID) -->
                <div>
                    <label for="username-display" class="block text-sm font-medium text-gray-700">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username-display" value="" disabled
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed input-locked">
                    <p class="mt-1 text-xs text-gray-500">T√™n ƒëƒÉng nh·∫≠p ch·ªâ c√≥ th·ªÉ thay ƒë·ªïi m·ªôt l·∫ßn (t√≠nh nƒÉng ph·ª©c t·∫°p,
                        t·∫°m th·ªùi b·ªã v√¥ hi·ªáu h√≥a).</p>
                </div>

                <!-- T√™n hi·ªÉn th·ªã -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">T√™n</label>
                    <input type="text" id="name" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-red-500 focus:ring-red-500">
                </div>

                <!-- Email - ƒê√£ thay ƒë·ªïi -->
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
                    <div class="flex items-center mt-1">
                        <input type="email" id="email-input" disabled
                            class="block w-full rounded-md border-gray-300 shadow-sm p-3 text-gray-700 transition duration-150 ease-in-out input-locked">
                        <!-- N√∫t Thay ƒê·ªïi (Icon B√∫t Ch√¨) -->
                        <button type="button" data-field="email"
                            class="edit-btn ml-4 p-2 text-gray-500 hover:text-red-500 transition duration-150 ease-in-out rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                            <i class="fas fa-pencil-alt text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- S·ªë ƒëi·ªán tho·∫°i - ƒê√£ thay ƒë·ªïi -->
                <div>
                    <label for="phone-input" class="block text-sm font-medium text-gray-700">S·ªë ƒëi·ªán tho·∫°i</label>
                    <div class="flex items-center mt-1">
                        <input type="tel" id="phone-input" disabled
                            class="block w-full rounded-md border-gray-300 shadow-sm p-3 text-gray-700 transition duration-150 ease-in-out input-locked">
                        <!-- N√∫t Thay ƒê·ªïi (Icon B√∫t Ch√¨) -->
                        <button type="button" data-field="phone"
                            class="edit-btn ml-4 p-2 text-gray-500 hover:text-red-500 transition duration-150 ease-in-out rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                            <i class="fas fa-pencil-alt text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Gi·ªõi t√≠nh -->
                <div class="flex items-center space-x-6">
                    <label class="block text-sm font-medium text-gray-700">Gi·ªõi t√≠nh</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <div class="flex items-center">
                            <input id="gender-male" name="gender" type="radio" value="Nam"
                                class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300">
                            <label for="gender-male" class="ml-2 block text-sm text-gray-900">Nam</label>
                        </div>
                        <div class="flex items-center">
                            <input id="gender-female" name="gender" type="radio" value="N·ªØ"
                                class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300">
                            <label for="gender-female" class="ml-2 block text-sm text-gray-900">N·ªØ</label>
                        </div>
                        <div class="flex items-center">
                            <input id="gender-other" name="gender" type="radio" value="Kh√°c"
                                class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300">
                            <label for="gender-other" class="ml-2 block text-sm text-gray-900">Kh√°c</label>
                        </div>
                    </div>
                </div>

                <a href="changepass.html" class="block text-red-600 hover:text-red-700 font-medium text-sm">ƒê·ªïi M·∫≠t
                    Kh·∫©u</a>
            </div>

            <div class="mt-8">
                <button type="submit" id="save-btn"
                    class="w-full md:w-auto rounded-md border border-transparent shadow-sm px-8 py-3 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                    L∆∞u
                </button>
            </div>
        </form>
    </div>

</body>
<script>
    // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C V√Ä H√ÄM C∆† B·∫¢N ---
    const AVATAR_KEY = 'userAvatar_';
    let currentUserId = null;
    let currentAvatarDataURL = null;
    const feedbackEl = document.getElementById('global-feedback');
    const avatarPreviewEl = document.getElementById('avatar-preview');
    const loadingEl = document.getElementById('loading');

    // C√°c input c·∫ßn ki·ªÉm so√°t tr·∫°ng th√°i kh√≥a
    const editableInputs = [
        { id: 'email-input', key: 'email' },
        { id: 'phone-input', key: 'phone' }
    ];

    /**
     * Hi·ªÉn th·ªã th√¥ng b√°o ph·∫£n h·ªìi
     * @param {string} msg - N·ªôi dung th√¥ng b√°o
     * @param {boolean} isSuccess - Tr·∫°ng th√°i (true: th√†nh c√¥ng, false: l·ªói)
     */
    function showFeedback(msg, isSuccess) {
        feedbackEl.textContent = msg;
        feedbackEl.className = isSuccess ? 'feedback success' : 'feedback error';
        feedbackEl.style.display = 'block';
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, 5000);
    }

    // --- H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU LOCAL/SESSION STORAGE ---

    function getAccounts() {
        const accounts = localStorage.getItem('userAccounts');
        return accounts ? JSON.parse(accounts) : [];
    }

    function saveAccounts(accounts) {
        localStorage.setItem('userAccounts', JSON.stringify(accounts));
    }

    function getLoggedInUser() {
        const user = sessionStorage.getItem('loggedInUser');
        return user ? JSON.parse(user) : null;
    }

    function updateSessionUser(user) {
        sessionStorage.setItem('loggedInUser', JSON.stringify(user));
    }

    function loadAvatar(userId) {
        return localStorage.getItem(AVATAR_KEY + userId);
    }

    function saveAvatar(userId, dataURL) {
        localStorage.setItem(AVATAR_KEY + userId, dataURL);
    }

    function logout() {
        sessionStorage.removeItem('loggedInUser');
        window.location.href = 'login.html';
    }

    // --- H√ÄM M·ªöI: QU·∫¢N L√ù TR·∫†NG TH√ÅI INPUT KH√ìA/M·ªû ---
    /**
     * Kh√≥a ho·∫∑c m·ªü kh√≥a input Email/Phone
     * @param {string} inputId - ID c·ªßa input
     * @param {boolean} lock - true ƒë·ªÉ kh√≥a, false ƒë·ªÉ m·ªü kh√≥a
     */
    function toggleInputLock(inputId, lock) {
        const inputEl = document.getElementById(inputId);
        if (lock) {
            inputEl.disabled = true;
            inputEl.classList.remove('input-editable');
            inputEl.classList.add('input-locked');
            inputEl.removeAttribute('required'); // Lo·∫°i b·ªè required khi kh√≥a
        } else {
            inputEl.disabled = false;
            inputEl.classList.remove('input-locked');
            inputEl.classList.add('input-editable');
            inputEl.focus();
            inputEl.setAttribute('required', 'required'); // Th√™m required khi m·ªü kh√≥a
        }
    }


    // --- X·ª¨ L√ù T·∫¢I D·ªÆ LI·ªÜU BAN ƒê·∫¶U ---

    function loadProfileData() {
        const loggedInUser = getLoggedInUser();

        if (!loggedInUser) {
            showFeedback('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. ƒêang chuy·ªÉn h∆∞·ªõng...', false);
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        currentUserId = loggedInUser.id;
        loadingEl.classList.remove('hidden');

        // 1. T·∫£i th√¥ng tin c√° nh√¢n
        const accounts = getAccounts();
        const userAccount = accounts.find(acc => acc.id === currentUserId);

        if (userAccount) {
            document.getElementById('username-display').value = userAccount.username || '';
            document.getElementById('name').value = userAccount.name || userAccount.username || '';

            // ƒê·∫∑t gi√° tr·ªã cho Email v√† Phone (lu√¥n kh√≥a khi kh·ªüi t·∫°o)
            document.getElementById('email-input').value = userAccount.email || '';
            document.getElementById('phone-input').value = userAccount.phone || '';

            // ƒê·∫∑t gi·ªõi t√≠nh
            const gender = userAccount.gender;
            if (gender) {
                const radioEl = document.querySelector(`input[name="gender"][value="${gender}"]`);
                if (radioEl) radioEl.checked = true;
            }
        } else {
            showFeedback('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t√†i kho·∫£n trong Local Storage.', false);
        }

        // 2. T·∫£i Avatar
        const storedAvatar = loadAvatar(currentUserId);
        if (storedAvatar) {
            avatarPreviewEl.src = storedAvatar;
            currentAvatarDataURL = storedAvatar;
        } else {
            avatarPreviewEl.src = "https://placehold.co/128x128/bdbdbd/ffffff?text=Avatar";
            currentAvatarDataURL = null;
        }

        loadingEl.classList.add('hidden');
    }


    // --- X·ª¨ L√ù UPLOAD AVATAR ---

    document.getElementById('avatar-upload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) return;

        // Ki·ªÉm tra dung l∆∞·ª£ng (max 1MB)
        if (file.size > 1024 * 1024) {
            showFeedback('K√≠ch th∆∞·ªõc ·∫£nh t·ªëi ƒëa l√† 1MB!', false);
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const dataURL = e.target.result;
            currentAvatarDataURL = dataURL;
            avatarPreviewEl.src = dataURL;

            saveAvatar(currentUserId, dataURL);
            showFeedback('·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', true);

            const loggedInUser = getLoggedInUser();
            if (loggedInUser) {
                loggedInUser.avatar = dataURL;
                updateSessionUser(loggedInUser);
            }
        }

        reader.readAsDataURL(file);
    });

    // --- X·ª¨ L√ù M·ªû KH√ìA INPUT B·∫∞NG N√öT B√öT CH√å ---
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function () {
            const field = this.getAttribute('data-field'); // 'email' ho·∫∑c 'phone'
            const inputId = field + '-input';

            // M·ªü kh√≥a input t∆∞∆°ng ·ª©ng
            toggleInputLock(inputId, false);
        });
    });

    // --- X·ª¨ L√ù L∆ØU TH√îNG TIN PROFILE ---

    document.getElementById('profile-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;

        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email-input').value.trim();
        const phone = document.getElementById('phone-input').value.trim();
        const selectedGender = document.querySelector('input[name="gender"]:checked');
        const genderValue = selectedGender ? selectedGender.value : null;

        if (!name) {
            showFeedback('Vui l√≤ng nh·∫≠p T√™n hi·ªÉn th·ªã!', false);
            saveBtn.disabled = false;
            return;
        }

        // Ki·ªÉm tra validation ƒë∆°n gi·∫£n cho email v√† phone n·∫øu ch√∫ng ƒë∆∞·ª£c m·ªü kh√≥a
        const emailInput = document.getElementById('email-input');
        const phoneInput = document.getElementById('phone-input');

        if (!emailInput.disabled && !/^.+@.+\..+$/.test(email)) {
            showFeedback('ƒê·ªãa ch·ªâ Email kh√¥ng h·ª£p l·ªá!', false);
            saveBtn.disabled = false;
            return;
        }

        if (!phoneInput.disabled && !/^\d{9,15}$/.test(phone)) {
            showFeedback('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (9-15 ch·ªØ s·ªë)!', false);
            saveBtn.disabled = false;
            return;
        }

        const accounts = getAccounts();
        const userIndex = accounts.findIndex(acc => acc.id === currentUserId);

        let success = false;

        if (userIndex !== -1) {
            // C·∫≠p nh·∫≠t th√¥ng tin profile v√†o Local Storage
            accounts[userIndex].name = name;
            accounts[userIndex].gender = genderValue;

            // C·∫≠p nh·∫≠t Email v√† Phone (ch·ªâ c·∫ßn l·∫•y gi√° tr·ªã hi·ªán t·∫°i, v√¨ n√≥ ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra khi m·ªü kh√≥a)
            accounts[userIndex].email = email;
            accounts[userIndex].phone = phone;

            // X·ª≠ l√Ω Avatar
            if (currentAvatarDataURL) {
                saveAvatar(currentUserId, currentAvatarDataURL);
                accounts[userIndex].avatar = currentAvatarDataURL;
            } else {
                delete accounts[userIndex].avatar;
                localStorage.removeItem(AVATAR_KEY + currentUserId);
            }

            saveAccounts(accounts); // L∆∞u to√†n b·ªô danh s√°ch t√†i kho·∫£n

            // C·∫≠p nh·∫≠t Session Storage ƒë·ªÉ duy tr√¨ tr·∫°ng th√°i ƒëƒÉng nh·∫≠p m·ªõi
            const updatedSessionUser = {
                ...getLoggedInUser(),
                name: name,
                gender: genderValue,
                email: email, // C·∫≠p nh·∫≠t email session
                phone: phone, // C·∫≠p nh·∫≠t phone session
                avatar: accounts[userIndex].avatar || null
            };
            updateSessionUser(updatedSessionUser);

            // --- KH√ìA L·∫†I INPUT SAU KHI L∆ØU TH√ÄNH C√îNG ---
            editableInputs.forEach(item => {
                toggleInputLock(item.id, true); // Kh√≥a l·∫°i
            });
            // ---------------------------------------------

            success = true;
        } else {
            showFeedback('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n ƒë·ªÉ c·∫≠p nh·∫≠t.', false);
        }

        saveBtn.disabled = false;

        if (success) {
            showFeedback('ü•≥ H·ªì s∆° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u v√† c·∫≠p nh·∫≠t th√†nh c√¥ng!', true);
        }
    });

    // X·ª≠ l√Ω ƒêƒÉng xu·∫•t
    document.getElementById('logout-btn').addEventListener('click', logout);


    // --- KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG ---
    window.onload = function () {
        loadProfileData();
        // ƒê·∫£m b·∫£o c√°c input Email/Phone lu√¥n b·ªã kh√≥a khi trang t·∫£i xong
        editableInputs.forEach(item => {
            toggleInputLock(item.id, true);
        });
    };

</script>

</html>