<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Sản Phẩm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        h1 {
            color: red !important;
        }

        /* Thêm CSS cho Segmented Control */
        .segmented-control button {
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .segmented-control button:first-child {
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        .segmented-control button:last-child {
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <div
        class="w-72 bg-white text-gray-800 p-6 shadow-xl flex-shrink-0 flex flex-col items-center fixed top-0 left-0 h-full">
        <h1 class="text-3xl font-bold mb-8 text-center text-red-700">AnhEm Motor</h1>
        <nav class="w-full">
            <ul class="space-y-4">
                <li>
                    <a href="index.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-house w-6 text-xl text-center text-red-600"></i>
                        <span>Trang chủ</span>
                    </a>
                </li>
                <li>
                    <a href="report.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-chart-line w-6 text-xl text-center text-red-600"></i>
                        <span>Báo cáo</span>
                    </a>
                </li>
                <li>
                    <a href="revenue.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-chart-pie w-6 text-xl text-center text-red-600"></i>
                        <span>Phân Tích Doanh Thu</span>
                    </a>
                </li>
                <li>
                    <a href="inventory.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-box w-6 text-xl text-center text-red-600"></i>
                        <span>Báo Cáo Sản Phẩm</span>
                    </a>
                </li>
                <li>
                    <a href="quanlykh.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-users w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Khách Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="order1.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-cart-shopping w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Đơn Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="nhaphang.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-truck-ramp-box w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Nhập Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="quanlysp.html"
                        class="flex items-center space-x-3 p-3 rounded-lg bg-red-100 text-red-700 transition-colors duration-200">
                        <i class="fa-solid fa-motorcycle w-6 text-xl text-center text-red-700"></i>
                        <span>Quản lý Sản Phẩm</span>
                    </a>
                </li>
                <li>
                    <a href="warehouse.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-box w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Kho</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8 bg-white flex flex-col items-center ml-72">
        <!-- Bọc nội dung chính vào một div giới hạn chiều rộng và căn giữa -->
        <div class="w-full max-w-6xl mx-auto">
            <div class="p-6 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold mb-4 text-center text-gray-800">Danh Sách Sản Phẩm</h1>

                <!-- Đã sửa: Thay justify-between bằng justify-center để căn giữa toàn bộ nhóm nút -->
                <div
                    class="flex flex-col lg:flex-row justify-center items-start lg:items-center mb-6 space-y-4 lg:space-y-0">
                    <div
                        class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full lg:w-auto items-center">

                        <!-- START: Segmented Control - Nút Lọc Trạng Thái MỚI -->
                        <div class="flex rounded-lg border border-gray-300 bg-gray-100 p-0.5 segmented-control">
                            <button onclick="filterProducts('all')" id="filter-all"
                                class="px-4 py-2 text-sm font-medium rounded-lg text-gray-800 bg-blue-600 shadow-md">Tất
                                Cả</button>
                            <button onclick="filterProducts('in-stock')" id="filter-in-stock"
                                class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">Còn
                                Hàng</button>
                            <button onclick="filterProducts('low-stock')" id="filter-low-stock"
                                class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">Sắp
                                Hết</button>
                            <button onclick="filterProducts('out-of-stock')" id="filter-out-of-stock"
                                class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">Hết
                                Hàng</button>
                        </div>
                        <!-- END: Segmented Control - Nút Lọc Trạng Thái MỚI -->

                        <span class="text-gray-400 mx-4 hidden sm:block">|</span>

                        <div class="flex space-x-2">
                            <a href="themsp.html"
                                class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-400 text-white hover:bg-purple-700 transition-colors duration-200 flex items-center space-x-2 shadow-md">
                                <i class="fas fa-plus text-white text-xs"></i>
                                <span>Thêm SP</span>
                            </a>
                            <label for="excel-import"
                                class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200 cursor-pointer flex items-center space-x-2 shadow-md">
                                <i class="fas fa-upload text-white text-xs"></i>
                                <span>Import</span>
                            </label>
                            <input type="file" id="excel-import" accept=".xlsx,.xls" onchange="importExcel(event)"
                                class="file-input">

                            <button onclick="exportExcel()"
                                class="px-4 py-2 rounded-lg text-sm font-medium bg-green-600 text-white hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2 shadow-md">
                                <i class="fas fa-download text-white text-xs"></i>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <input type="text" id="search-input" placeholder="Tìm kiếm sản phẩm..." onkeyup="searchProducts()"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Mã SP</th>
                                <th class="py-3 px-6 text-left">Tên Sản Phẩm</th>
                                <th class="py-3 px-6 text-left">Danh Mục</th>
                                <th class="py-3 px-6 text-left">Số Lượng</th>
                                <th class="py-3 px-6 text-left">Trạng Thái</th>
                                <th class="py-3 px-6 text-center">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light" id="product-table-body">
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex justify-center items-center space-x-2">
                    <button id="prev-page"
                        class="px-4 py-2 bg-gray-300 rounded-lg disabled:opacity-50 hover:bg-gray-400 transition-colors duration-200">Trước</button>
                    <span id="page-info" class="text-sm text-gray-700">Trang 1</span>
                    <button id="next-page"
                        class="px-4 py-2 bg-gray-300 rounded-lg disabled:opacity-50 hover:bg-gray-400 transition-colors duration-200">Sau</button>
                </div>

            </div>
        </div>
        <!-- Kết thúc div giới hạn chiều rộng và căn giữa -->
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Chỉnh Sửa Sản Phẩm</h2>
            <form id="edit-product-form" onsubmit="updateProduct(event)">
                <input type="hidden" id="edit-product-index">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="edit-product-code" placeholder="Mã Sản Phẩm" required
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="edit-product-name" placeholder="Tên Sản Phẩm" required
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="edit-product-category" required
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Chọn Danh Mục</option>
                        <option value="Xe Máy">Xe Máy</option>
                        <option value="Phụ Kiện">Phụ Kiện</option>
                        <option value="Phụ Tùng">Phụ Tùng</option>
                    </select>
                    <input type="number" id="edit-product-price" placeholder="Giá Bán" required min="0"
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="edit-product-cost" placeholder="Giá Vốn" required min="0"
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="edit-product-quantity" placeholder="Số Lượng" required min="0"
                        class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <textarea id="edit-product-description" placeholder="Mô Tả Sản Phẩm" rows="3"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit"
                        class="flex-1 py-3 rounded-lg text-lg font-bold bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">Cập
                        Nhật</button>
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 py-3 rounded-lg text-lg font-bold bg-gray-500 text-white hover:bg-gray-600 transition-colors duration-200">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Product data with localStorage integration
        let products = JSON.parse(localStorage.getItem('products')) || [
            { code: 'SP001', name: 'Honda Wave RSX', category: 'Xe Máy', price: 25000000, cost: 22000000, quantity: 15, description: 'Xe máy Honda Wave RSX 110cc' },
            { code: 'SP002', name: 'Yamaha Jupiter', category: 'Xe Máy', price: 27000000, cost: 24000000, quantity: 8, description: 'Xe máy Yamaha Jupiter Fi 115cc' },
            { code: 'SP003', name: 'Mũ Bảo Hiểm Royal', category: 'Phụ Kiện', price: 350000, cost: 250000, quantity: 45, description: 'Mũ bảo hiểm Royal M20' },
            { code: 'SP004', name: 'Lốp Michelin City Grip', category: 'Phụ Tùng', price: 1200000, cost: 950000, quantity: 2, description: 'Lốp Michelin City Grip 80/90-14' },
            { code: 'SP005', name: 'Dầu Nhớt Castrol', category: 'Phụ Tùng', price: 85000, cost: 65000, quantity: 0, description: 'Dầu nhớt Castrol 10W-30 1L' }
        ];

        const LOW_STOCK_THRESHOLD = 10;
        const stockStatusColors = {
            'in-stock': 'bg-green-100 text-green-800',
            'low-stock': 'bg-yellow-100 text-yellow-800',
            'out-of-stock': 'bg-red-100 text-red-800'
        };
        const stockStatusText = {
            'in-stock': 'Còn Hàng',
            'low-stock': 'Sắp Hết',
            'out-of-stock': 'Hết Hàng'
        };

        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let currentProducts = [];

        // Save products to localStorage
        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function getStockStatus(quantity) {
            if (quantity === 0) return 'out-of-stock';
            if (quantity <= LOW_STOCK_THRESHOLD) return 'low-stock';
            return 'in-stock';
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' VNĐ';
        }

        function renderProducts(productList) {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';

            currentProducts = productList;
            const totalPages = Math.ceil(currentProducts.length / ITEMS_PER_PAGE);

            // Đảm bảo currentPage không vượt quá tổng số trang sau khi lọc/tìm kiếm
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 0;
            } else if (currentPage === 0 && totalPages > 0) {
                currentPage = 1;
            }


            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedProducts = currentProducts.slice(start, end);

            if (currentProducts.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Không có sản phẩm nào để hiển thị.</td></tr>`; // Cột colspan giảm từ 6 xuống 5
                document.getElementById('page-info').textContent = `Trang 0 / 0`;
                document.getElementById('prev-page').disabled = true;
                document.getElementById('next-page').disabled = true;
                return;
            }

            paginatedProducts.forEach((product) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-200 transition-colors duration-200';

                const stockStatus = getStockStatus(product.quantity);
                const statusColor = stockStatusColors[stockStatus];
                const statusLabel = stockStatusText[stockStatus];

                // Đã BỎ CỘT GIÁ (price) trong HTML row
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${product.code}</td>
                    <td class="py-3 px-6 text-left">${product.name}</td>
                    <td class="py-3 px-6 text-left">${product.category}</td>
                    <td class="py-3 px-6 text-left">${product.quantity}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="px-2 py-1 font-semibold leading-tight ${statusColor} rounded-full text-xs">${statusLabel}</span>
                    </td>
                    <td class="py-3 px-6 text-center space-x-2">
                        <button onclick="editProduct('${product.code}')" class="text-blue-600 hover:underline text-sm font-medium">Sửa</button>
                        <button onclick="deleteProduct('${product.code}')" class="text-red-600 hover:underline text-sm font-medium">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('page-info').textContent = `Trang ${currentPage} / ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function editProduct(code) {
            const index = products.findIndex(p => p.code === code);
            const product = products[index];
            if (!product) return;

            document.getElementById('edit-product-index').value = index;
            document.getElementById('edit-product-code').value = product.code;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-price').value = product.price; // Giữ lại giá trong modal để chỉnh sửa
            document.getElementById('edit-product-cost').value = product.cost;
            document.getElementById('edit-product-quantity').value = product.quantity;
            document.getElementById('edit-product-description').value = product.description;

            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function updateProduct(event) {
            event.preventDefault();
            const index = parseInt(document.getElementById('edit-product-index').value);
            const updatedProduct = {
                code: document.getElementById('edit-product-code').value,
                name: document.getElementById('edit-product-name').value,
                category: document.getElementById('edit-product-category').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                cost: parseFloat(document.getElementById('edit-product-cost').value),
                quantity: parseInt(document.getElementById('edit-product-quantity').value),
                description: document.getElementById('edit-product-description').value
            };

            if (products.some((p, i) => p.code === updatedProduct.code && i !== index)) {
                // Thay thế alert() bằng một modal hoặc thông báo tùy chỉnh
                showCustomMessage('Mã sản phẩm đã tồn tại!', 'error');
                return;
            }

            products[index] = updatedProduct;
            saveProducts();
            closeEditModal();
            filterAndRender();
        }

        function deleteProduct(code) {
            showCustomConfirmation('Bạn có chắc chắn muốn xóa sản phẩm này?', () => {
                const index = products.findIndex(p => p.code === code);
                products.splice(index, 1);
                saveProducts();
                filterAndRender();
            });
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
        }

        function updateFilterButtonStyles(status) {
            const filterButtons = document.querySelectorAll('.segmented-control button');
            filterButtons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('text-gray-700', 'hover:bg-gray-200');
            });

            const activeButton = document.getElementById(`filter-${status}`);
            if (activeButton) {
                activeButton.classList.remove('text-gray-700', 'hover:bg-gray-200');
                activeButton.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }
        }

        function filterProducts(status) {
            updateFilterButtonStyles(status);

            let filteredList = [];
            if (status === 'all') {
                filteredList = products;
            } else {
                filteredList = products.filter(product => getStockStatus(product.quantity) === status);
            }

            currentPage = 1;
            renderProducts(filteredList);
        }

        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            // Lấy trạng thái lọc hiện tại
            const activeButton = document.querySelector('.segmented-control .bg-blue-600');
            const filteredStatus = activeButton ? activeButton.id.replace('filter-', '') : 'all';

            let listToSearch = products;
            if (filteredStatus !== 'all') {
                listToSearch = products.filter(product => getStockStatus(product.quantity) === filteredStatus);
            }

            const searchResults = listToSearch.filter(product =>
                product.code.toLowerCase().includes(searchTerm) ||
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            currentPage = 1;
            renderProducts(searchResults);
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet);

                    const importedProducts = data.map(row => ({
                        code: (row['Mã SP'] || row['Code'] || '').toString().trim(), // Đảm bảo là string
                        name: (row['Tên Sản Phẩm'] || row['Name'] || '').toString().trim(),
                        category: (row['Danh Mục'] || row['Category'] || '').toString().trim(),
                        price: parseFloat(row['Giá Bán'] || row['Price'] || 0),
                        cost: parseFloat(row['Giá Vốn'] || row['Cost'] || 0),
                        quantity: parseInt(row['Số Lượng'] || row['Quantity'] || 0),
                        description: (row['Mô Tả'] || row['Description'] || '').toString().trim()
                    }));

                    const validProducts = importedProducts.filter(product => {
                        if (!product.code || !product.name) {
                            console.warn(`Sản phẩm không hợp lệ (thiếu Mã SP/Tên SP) sẽ bị bỏ qua.`);
                            return false;
                        }
                        if (products.some(p => p.code === product.code)) {
                            console.warn(`Sản phẩm với mã ${product.code} đã tồn tại và sẽ bị bỏ qua.`);
                            return false;
                        }
                        return true;
                    });

                    if (validProducts.length > 0) {
                        products.push(...validProducts);
                        saveProducts();
                        filterAndRender();
                        showCustomMessage(`Đã import thành công ${validProducts.length} sản phẩm!`, 'success');
                    } else {
                        showCustomMessage('Không có sản phẩm hợp lệ nào để import! Vui lòng kiểm tra định dạng cột.', 'error');
                    }
                } catch (error) {
                    console.error('Error importing Excel:', error);
                    showCustomMessage('Có lỗi xảy ra khi import file Excel. Vui lòng kiểm tra định dạng file.', 'error');
                }
            };
            reader.readAsBinaryString(file);
            event.target.value = ''; // Reset file input
        }

        function exportExcel() {
            if (products.length === 0) {
                showCustomMessage('Không có dữ liệu để xuất!', 'info');
                return;
            }

            // Export Data, BỎ CỘT GIÁ BÁN (Giá Bán)
            const exportData = products.map(product => ({
                'Mã SP': product.code,
                'Tên Sản Phẩm': product.name,
                'Danh Mục': product.category,
                // 'Giá Bán': product.price, // Đã bỏ theo yêu cầu
                'Giá Vốn': product.cost,
                'Số Lượng': product.quantity,
                'Trạng Thái': stockStatusText[getStockStatus(product.quantity)],
                'Mô Tả': product.description
            }));

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(exportData);

            // Cập nhật colWidths cho phù hợp với các cột còn lại
            const colWidths = [
                { wch: 10 }, { wch: 25 }, { wch: 15 },
                { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 30 } // 7 cột thay vì 8
            ];
            worksheet['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(workbook, worksheet, 'Danh Sách Sản Phẩm');

            const currentDate = new Date().toISOString().split('T')[0];
            const filename = `DanhSachSanPham_${currentDate}.xlsx`;

            XLSX.writeFile(workbook, filename);
        }

        function filterAndRender() {
            // Lấy trạng thái lọc hiện tại
            const filterButton = document.querySelector('.segmented-control .bg-blue-600');
            const filteredStatus = filterButton ? filterButton.id.replace('filter-', '') : 'all';

            // Lấy từ khóa tìm kiếm hiện tại
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            let listToRender = products;

            // Áp dụng lọc trạng thái
            if (filteredStatus !== 'all') {
                listToRender = listToRender.filter(product => getStockStatus(product.quantity) === filteredStatus);
            }

            // Áp dụng tìm kiếm
            if (searchTerm) {
                listToRender = listToRender.filter(product =>
                    product.code.toLowerCase().includes(searchTerm) ||
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            }

            // Đảm bảo trang hiện tại hợp lệ sau khi lọc/tìm kiếm
            const totalPages = Math.ceil(listToRender.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 0;
            } else if (currentPage === 0 && totalPages > 0) {
                currentPage = 1;
            }


            renderProducts(listToRender);
        }

        // Pagination handlers
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderProducts(currentProducts);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(currentProducts.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderProducts(currentProducts);
            }
        });

        // Close modal when clicking outside
        document.getElementById('edit-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Custom Message Box
        function showCustomMessage(message, type) {
            // Tạo modal container
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm mx-4 text-center">
                    <p class="text-lg mb-4 text-gray-800">${message}</p>
                    <button class="px-6 py-2 rounded-lg text-white font-semibold transition-colors duration-200 bg-blue-500 hover:bg-blue-600">OK</button>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Custom Confirmation Box
        function showCustomConfirmation(message, onConfirm) {
            // Tạo modal container
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm mx-4 text-center">
                    <p class="text-lg mb-4 text-gray-800">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button class="flex-1 py-2 rounded-lg text-white font-semibold transition-colors duration-200 bg-red-500 hover:bg-red-600">Xác nhận</button>
                        <button class="flex-1 py-2 rounded-lg text-white font-semibold transition-colors duration-200 bg-gray-500 hover:bg-gray-600">Hủy</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelectorAll('button')[0].addEventListener('click', () => {
                onConfirm();
                document.body.removeChild(modal);
            });
            modal.querySelectorAll('button')[1].addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Cập nhật lại logic init để dùng hàm updateFilterButtonStyles mới
            updateFilterButtonStyles('all');
            filterAndRender();
        });
    </script>

</body>

</html>