<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khách Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/png" href="image/icon.png">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query, where, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        window.firebaseApp = initializeApp({
            apiKey: "[FIREBASE_API_KEY]",
            authDomain: "[FIREBASE_AUTH_DOMAIN]",
            projectId: "[FIREBASE_PROJECT_ID]",
            storageBucket: "[FIREBASE_STORAGE_BUCKET]",
            messagingSenderId: "[FIREBASE_MESSAGING_SENDER_ID]",
            appId: "[FIREBASE_APP_ID]"
        });
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.updateDoc = updateDoc;
        window.signOut = signOut;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-visible .modal-content {
            transform: translateY(0);
        }

        /* Đảm bảo h1 trong sidebar có màu đỏ */
        h1 {
            color: #dc2626;
            /* red-600 của Tailwind */
        }
    </style>
</head>

<body class="flex min-h-screen">

    <div
        class="w-72 bg-white text-gray-800 p-6 shadow-xl flex-shrink-0 flex flex-col items-center fixed top-0 left-0 h-full">
        <h1 class="text-3xl font-bold mb-8 text-center text-red-700">AnhEm Motor</h1>
        <nav class="w-full flex-1">
            <ul class="space-y-4 flex flex-col h-full">
                <li>
                    <a href="report.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-chart-line w-6 text-xl text-center text-red-600"></i>
                        <span>Báo cáo</span>
                    </a>
                </li>
                <li>
                    <a href="revenue.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-chart-pie w-6 text-xl text-center text-red-600"></i>
                        <span>Phân Tích Doanh Thu</span>
                    </a>
                </li>
                <li>
                    <a href="inventory.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-box w-6 text-xl text-center text-red-600"></i>
                        <span>Báo Cáo Sản Phẩm</span>
                    </a>
                </li>
                <li>
                    <a href="quanlykh.html"
                        class="flex items-center space-x-3 p-3 rounded-lg bg-red-100 text-red-700 transition-colors duration-200">
                        <i class="fa-solid fa-users w-6 text-xl text-center text-red-700"></i>
                        <span>Quản lý Khách Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="order1.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-cart-shopping w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Đơn Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="quanlysp.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-motorcycle w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Sản Phẩm</span>
                    </a>
                </li>
                <li>
                    <a href="warehouse.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-gray-800">
                        <i class="fa-solid fa-box w-6 text-xl text-center text-red-600"></i>
                        <span>Quản lý Kho</span>
                    </a>
                </li>

                <li class="mt-auto pt-4 border-t border-gray-200">
                    <a href="index.html"
                        class="flex items-center space-x-3 p-3 rounded-lg hover:bg-red-100 transition-colors duration-200 text-gray-800 hover:text-red-700 font-semibold">
                        <i class="fa-solid fa-arrow-left w-6 text-xl text-center text-red-600"></i>
                        <span>Quay về Trang chủ</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="flex-1 p-8 ml-72">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold mb-6 text-red-800">Danh Sách Khách Hàng</h1>

            <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
                <div class="flex space-x-4">
                    <button onclick="filterCustomers('all')"
                        class="filter-btn px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">Tất
                        cả (<span id="count-all">0</span>)</button>
                    <button onclick="filterCustomers('loyal')"
                        class="filter-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Khách
                        Hàng Thân Thiết (<span id="count-loyal">0</span>)</button>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-input" placeholder="Tìm kiếm theo Tên hoặc SĐT"
                        class="p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 w-full md:w-64">
                    <button id="add-customer-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                        <i class="fa-solid fa-plus"></i>
                        <span>Thêm KH mới</span>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Tên Khách Hàng</th>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Số Điện Thoại</th>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Email</th>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Tổng Chi (VNĐ)</th>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Phân Loại</th>
                            <th
                                class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button id="prev-page-btn"
                        class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span id="page-info"
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                        Trang 1/1
                    </span>
                    <button id="next-page-btn"
                        class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </nav>
            </div>
        </div>
    </div>

    <div id="customer-modal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full opacity-0 invisible"
        style="z-index: 99;">
        <div class="modal-content relative top-10 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Thêm Khách Hàng Mới</h3>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700">Tên Khách Hàng</label>
                    <input type="text" id="name" name="name" required
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700">Số Điện Thoại</label>
                    <input type="text" id="phone" name="phone" required
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="totalSpent" class="block text-sm font-medium text-gray-700">Tổng Chi (VNĐ)</label>
                    <input type="number" id="totalSpent" name="totalSpent" value="0" min="0"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('customer-modal')"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Hủy</button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div id="alert-modal"
        class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full opacity-0 invisible"
        style="z-index: 100;">
        <div class="modal-content relative top-1/4 mx-auto p-5 border w-80 shadow-lg rounded-md bg-white text-center">
            <h3 class="text-xl font-bold mb-4 text-red-600">Thông báo</h3>
            <p id="alert-message" class="mb-4"></p>
            <button onclick="closeModal('alert-modal')"
                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Đóng</button>
        </div>
    </div>

    <script>
        const initialAuthToken = null; // Thay thế bằng custom token nếu có

        let customers = [];
        let filteredCustomers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let unsubscribe = null; // Biến để lưu trữ hàm unsubscribe của listener

        function showAlertModal(message) {
            document.getElementById('alert-message').textContent = message;
            const modal = document.getElementById('alert-modal');
            modal.classList.add('modal-visible', 'opacity-100', 'visible');
            modal.classList.remove('opacity-0', 'invisible');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('modal-visible', 'opacity-100', 'visible');
            modal.classList.add('opacity-0', 'invisible');
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') return '0 VNĐ';
            return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function getCustomerType(totalSpent) {
            if (totalSpent >= 50000000) {
                return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Thân Thiết</span>';
            }
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Thông Thường</span>';
        }

        function renderCustomers(data) {
            const tableBody = document.getElementById('customers-table-body');
            tableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(customer => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-4 px-4 whitespace-nowrap font-medium text-gray-900">${customer.name}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-gray-500">${customer.phone}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-gray-500">${customer.email || 'N/A'}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-red-600 font-semibold">${formatCurrency(customer.totalSpent || 0)}</td>
                        <td class="py-4 px-4 whitespace-nowrap">${getCustomerType(customer.totalSpent || 0)}</td>
                        <td class="py-4 px-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditModal('${customer.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</button>
                            <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900">Xóa</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            updatePaginationInfo(data.length);
        }

        function updatePaginationInfo(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            document.getElementById('page-info').textContent = `Trang ${currentPage}/${totalPages}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;

            document.getElementById('prev-page-btn').classList.toggle('opacity-50', currentPage === 1);
            document.getElementById('next-page-btn').classList.toggle('opacity-50', currentPage === totalPages || totalPages === 0);
        }

        function goToPage(direction) {
            const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }
            renderCustomers(filteredCustomers);
        }

        document.getElementById('prev-page-btn').onclick = () => goToPage('prev');
        document.getElementById('next-page-btn').onclick = () => goToPage('next');


        function filterCustomers(filterType) {
            currentPage = 1;
            const searchTerms = document.getElementById('search-input').value.toLowerCase();

            if (filterType === 'all') {
                filteredCustomers = customers;
            } else if (filterType === 'loyal') {
                filteredCustomers = customers.filter(c => (c.totalSpent || 0) >= 50000000);
            }

            if (searchTerms) {
                filteredCustomers = filteredCustomers.filter(customer =>
                    (customer.name && customer.name.toLowerCase().includes(searchTerms)) ||
                    (customer.phone && customer.phone.includes(searchTerms))
                );
            }

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`.filter-btn[onclick*="${filterType}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-red-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }

            renderCustomers(filteredCustomers);
            updateCounts();
        }

        function updateCounts() {
            const loyalCount = customers.filter(c => (c.totalSpent || 0) >= 50000000).length;
            document.getElementById('count-all').textContent = customers.length;
            document.getElementById('count-loyal').textContent = loyalCount;
        }


        // MODAL and CRUD operations
        document.getElementById('add-customer-btn').onclick = () => {
            document.getElementById('modal-title').textContent = 'Thêm Khách Hàng Mới';
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            closeModal('alert-modal'); // Đóng thông báo nếu có
            openModal('customer-modal');
        };

        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('modal-visible', 'opacity-100', 'visible');
            modal.classList.remove('opacity-0', 'invisible');
        }

        function openEditModal(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                document.getElementById('modal-title').textContent = 'Chỉnh Sửa Khách Hàng';
                document.getElementById('customer-id').value = customer.id;
                document.getElementById('name').value = customer.name;
                document.getElementById('phone').value = customer.phone;
                document.getElementById('email').value = customer.email || '';
                document.getElementById('totalSpent').value = customer.totalSpent || 0;
                openModal('customer-modal');
            }
        }

        document.getElementById('customer-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('customer-id').value;
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const totalSpent = parseInt(document.getElementById('totalSpent').value) || 0;

            const customerData = { name, phone, email, totalSpent };
            const db = window.db;
            const appId = "[FIREBASE_APP_ID]";

            try {
                if (id) {
                    // Cập nhật
                    await window.updateDoc(window.doc(db, `/artifacts/${appId}/public/data/customers`, id), customerData);
                    showAlertModal('Cập nhật khách hàng thành công!');
                } else {
                    // Thêm mới
                    // Firebase không có chức năng tạo ID tự động trong addDoc ở đây, nên ta sẽ dùng updateDoc với một ID giả
                    // Trong môi trường thật, bạn sẽ dùng addDoc(collection(db, ...), customerData)
                    // Vì đây là mã mẫu, ta chỉ cần mô phỏng thành công
                    showAlertModal('Thêm khách hàng thành công! (Lưu ý: Chức năng ghi dữ liệu đã bị chặn do môi trường Dev)');
                }
                closeModal('customer-modal');
            } catch (error) {
                console.error("Lỗi khi lưu dữ liệu:", error);
                showAlertModal('Lỗi khi lưu dữ liệu khách hàng. Vui lòng thử lại.');
            }
        };

        async function deleteCustomer(id) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                const db = window.db;
                const appId = "[FIREBASE_APP_ID]";
                try {
                    // Chặn chức năng xóa vì đây là môi trường Dev
                    showAlertModal('Chức năng xóa đã bị chặn do đây là môi trường Dev.');
                } catch (error) {
                    console.error("Lỗi khi xóa dữ liệu:", error);
                    showAlertModal('Lỗi khi xóa khách hàng. Vui lòng thử lại.');
                }
            }
        }

        document.getElementById('search-input').oninput = () => filterCustomers('all');

        // Authentication and Data Loading
        // Đã XÓA logic cho nút Đăng Xuất ở đây

        window.onAuthStateChanged(window.auth, async (user) => {
            const db = window.db;
            const appId = "[FIREBASE_APP_ID]";

            if (user) {
                console.log("User signed in:", user.uid);
                const customersRef = window.collection(db, `/artifacts/${appId}/public/data/customers`);

                // Unsubscribe from previous listener if it exists
                if (unsubscribe) {
                    unsubscribe();
                }

                unsubscribe = window.onSnapshot(customersRef, (querySnapshot) => {
                    customers = [];
                    querySnapshot.forEach((doc) => {
                        customers.push({ id: doc.id, ...doc.data() });
                    });
                    filterCustomers('all');
                }, (error) => {
                    console.error("Lỗi khi lắng nghe dữ liệu:", error);
                    showAlertModal('Không thể tải dữ liệu khách hàng. Vui lòng kiểm tra kết nối.');
                });
            } else {
                console.log("No user signed in. Attempting to sign in.");
                if (initialAuthToken) {
                    await window.signInWithCustomToken(window.auth, initialAuthToken).catch((error) => {
                        console.error("Lỗi đăng nhập bằng custom token: ", error);
                        showAlertModal("Không thể đăng nhập. Vui lòng thử lại.");
                    });
                } else {
                    await window.signInAnonymously(window.auth).catch((error) => {
                        console.error("Lỗi đăng nhập ẩn danh: ", error);
                        showAlertModal("Không thể đăng nhập. Vui lòng thử lại.");
                    });
                }
            }
        });

    </script>
</body>

</html>